---
title: "Wrangling freedive watch data in R"
output: html_document
tags:
- xml
- visualisation
- r
date: '2023-04-08'
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>Towards the end of 2021, I finally plucked up the courage to take a <a href="https://www.padi.com/education/freediving">freediving</a> course. At the time, I had never even tried Scuba diving, but a love of swimming and a childish love of trying to swim pool lengths underwater, combined with several <a href="https://www.youtube.com/watch?v=2-8g03IUY2k">inspiring videos</a>, was enough for me to give it a try. Since then, my diving has been limited to swimming pools in Amsterdam and very cold, dark Dutch lakes, together with a local dive group. But this year, I finally managed to get to Dahab, Egypt, to help prepare for the depth component of my <a href="https://www.aidainternational.org/Education/AIDAFreedivingCourses#aida3">AIDA3</a>.</p>
<div class="figure"><span style="display:block;" id="fig:photo"></span>
<img src="https://raw.githubusercontent.com/langtonhugh/freedives/main/img/photo_credited.png" alt="On the ascent in Dahab. Photo taken by Pete Botman. Credit also to Pete for lending me his Amsterdam-themed fins!"  />
<p class="caption">
Figure 1: On the ascent in Dahab. Photo taken by Pete Botman. Credit also to Pete for lending me his Amsterdam-themed fins!
</p>
</div>
<p>Freediving is pretty wholesome, and the gear-free component is part of what I enjoy so much, especially compared to Scuba. But before going to Dahab, I finally succumbed to buying a freedive watch (a Suunto D4F). The watch measures and records basic information about your dive, including important safety information such as your surface interval times. The inevitable problem is that the watch is fairly clumsy when it comes to viewing historical dives. I had all this awesome information on my dives locked away behind a black and white screen and a few buttons. I found the <a href="https://www.suunto.com/en-nl/Support/software-support/dm5/">Suunto desktop software</a> pretty outdated and restrictive. Opening it up gave me very <em>Windows 95</em> vibes (great vibes, but not what I am looking for here).</p>
<p>So, I set about exploring whether the data could be pulled off the watch and summarised using R. The ultimate aim might be to create an app in which people can drag-and-drop their own data. But, let’s not carried away. For now, if you want to replicate what I show below, you can find everything on an open <a href="https://github.com/langtonhugh/freedives">GitHub repository</a>. If you run the code on your own data, please let me know how you found it, and what I could add to improve things. This is very much an initial exploration.</p>
<div id="setup" class="section level2">
<h2>Setup</h2>
<p>The first thing you’ll need to do is load in a few packages. Nothing unusual here (mainly <code>tidyverse</code>-based packages). The exception is <code>XML</code> which we need to load in the data.</p>
<pre class="r"><code># Load packages.
library(XML)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(ggplot2)</code></pre>
</div>
<div id="loading-and-parsing" class="section level2">
<h2>Loading and parsing</h2>
<p>Each dive is archived into its own XML file. This means that even just for this year, I have 102 individual XML files. This is rather annoying but easily resolved by pasting together the working directories of all of these files based on their extension (i.e., .xml). If you use the corresponding GitHub repository, and work within the project file, all of this will run nice and smoothly. Nested within <code>paste()</code> is the <code>list.files()</code> function which simply produces a character vector for all the XML files in the specified folder. You can use this approach for any file type you want.</p>
<pre class="r"><code># List files.
dive_files &lt;- paste(&quot;data/2023/&quot;, list.files(&quot;data/2023/&quot;, pattern = glob2rx(&quot;*.xml&quot;),  recursive=TRUE), sep = &quot;&quot;)</code></pre>
<p>Now that we have all the working directories stored within the <code>dive_files</code> list object, we can run the <code>xmlParse()</code> function through the whole thing. This produces a list of XML documents, which we then further parse using <code>xmlToList()</code>. The output <code>dive_list</code> is a list of lists, but bear with me: we extract the useful information in one beautiful swoop in the next step.</p>
<pre class="r"><code># Load data.
dive_xml_list &lt;- lapply(dive_files, xmlParse)

# Parse into a list of lists.
dive_list &lt;- lapply(dive_xml_list, xmlToList)</code></pre>
</div>
<div id="the-pull-function" class="section level2">
<h2>The pull function</h2>
<p>This step is basically the only challenging part of the process. I would love someone with more experience in wrangling XML files to improve this. At the moment, I run a function which, for each dive record, creates a <code>tibble</code> containing the bits of information that we need, such as the date of the dive, the depth of dives, duration and temperature.</p>
<p>The one thing that makes this odd, and involving <em>yet more lists</em>, is that the watch measures depth and temperature at specified time intervals (a sampling rate) of two-seconds. Nevertheless, we can pull these out using <code>lapply()</code> and then convert to a numeric vector within this <code>tibble()</code> function. We also do some trivial extras, like convert the depth readings to a negative number. This function is the key to extracting your dive data in a usable <em>tidy</em> format.</p>
<pre class="r"><code># Function to pull out relevant information.
pull_fun &lt;- function(x){
tibble(
    mode  = x[[&quot;Mode&quot;]],
    date  = x[[&quot;StartTime&quot;]],
    depth = as.numeric(lapply(x[[&quot;DiveSamples&quot;]], function(y){y$Depth})),
    time  = as.numeric(lapply(x[[&quot;DiveSamples&quot;]], function(y){y$Time})),
    max_depth   = as.numeric(x[[&quot;MaxDepth&quot;]]),
    depth_minus = depth*-1,
    max_depth_minus = max_depth*-1,
    duration  = as.numeric(x[[&quot;Duration&quot;]]),
    temp  = as.numeric(lapply(x[[&quot;DiveSamples&quot;]], function(y)y$Temperature))
  ) %&gt;% 
    mutate(date = str_replace_all(date, &quot;T&quot;, &quot; &quot;),
           date_lub = ymd_hms(date),
           date_lub_min = round_date(date_lub, &quot;minute&quot;),
           date_day = round_date(date_lub, &quot;day&quot;))
}
</code></pre>
<p>Now for the magic: running this function through the list(s), and sticking it all together into a single <code>tibble</code>.</p>
<pre class="r"><code># Run function through list.
dive_df_list &lt;- lapply(dive_list, pull_fun)

# Bind together.
dive_info_df &lt;- bind_rows(dive_df_list, .id = &quot;dive_id&quot;)</code></pre>
<p>In case you are not running this as we go along, the output looks like our ol’ familiar data frames with rows and columns. The data frame is in long format: we have two-second samples nested within each dive id. This is just the first ten rows.</p>
<table>
<thead>
<tr>
<th style="text-align:right;">
dive_id
</th>
<th style="text-align:right;">
mode
</th>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
depth
</th>
<th style="text-align:right;">
time
</th>
<th style="text-align:right;">
max_depth
</th>
<th style="text-align:right;">
depth_minus
</th>
<th style="text-align:right;">
max_depth_minus
</th>
<th style="text-align:right;">
duration
</th>
<th style="text-align:right;">
temp
</th>
<th style="text-align:left;">
date_lub
</th>
<th style="text-align:left;">
date_lub_min
</th>
<th style="text-align:left;">
date_day
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 11:18:09
</td>
<td style="text-align:right;">
1.58
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2.01
</td>
<td style="text-align:right;">
-1.58
</td>
<td style="text-align:right;">
-2.01
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 11:18:09
</td>
<td style="text-align:left;">
2023-01-15 11:18:00
</td>
<td style="text-align:left;">
2023-01-15
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 11:23:29
</td>
<td style="text-align:right;">
1.22
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2.57
</td>
<td style="text-align:right;">
-1.22
</td>
<td style="text-align:right;">
-2.57
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 11:23:29
</td>
<td style="text-align:left;">
2023-01-15 11:23:00
</td>
<td style="text-align:left;">
2023-01-15
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 11:27:32
</td>
<td style="text-align:right;">
1.90
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
7.32
</td>
<td style="text-align:right;">
-1.90
</td>
<td style="text-align:right;">
-7.32
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 11:27:32
</td>
<td style="text-align:left;">
2023-01-15 11:28:00
</td>
<td style="text-align:left;">
2023-01-15
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 11:31:16
</td>
<td style="text-align:right;">
1.63
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6.00
</td>
<td style="text-align:right;">
-1.63
</td>
<td style="text-align:right;">
-6.00
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 11:31:16
</td>
<td style="text-align:left;">
2023-01-15 11:31:00
</td>
<td style="text-align:left;">
2023-01-15
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 11:40:38
</td>
<td style="text-align:right;">
1.69
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
7.42
</td>
<td style="text-align:right;">
-1.69
</td>
<td style="text-align:right;">
-7.42
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 11:40:38
</td>
<td style="text-align:left;">
2023-01-15 11:41:00
</td>
<td style="text-align:left;">
2023-01-15
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 12:03:12
</td>
<td style="text-align:right;">
1.74
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6.16
</td>
<td style="text-align:right;">
-1.74
</td>
<td style="text-align:right;">
-6.16
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 12:03:12
</td>
<td style="text-align:left;">
2023-01-15 12:03:00
</td>
<td style="text-align:left;">
2023-01-16
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-15 12:11:40
</td>
<td style="text-align:right;">
1.49
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.71
</td>
<td style="text-align:right;">
-1.49
</td>
<td style="text-align:right;">
-1.71
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
6.999994
</td>
<td style="text-align:left;">
2023-01-15 12:11:40
</td>
<td style="text-align:left;">
2023-01-15 12:12:00
</td>
<td style="text-align:left;">
2023-01-16
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-20 11:11:23
</td>
<td style="text-align:right;">
2.17
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.44
</td>
<td style="text-align:right;">
-2.17
</td>
<td style="text-align:right;">
-4.44
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
24.999994
</td>
<td style="text-align:left;">
2023-01-20 11:11:23
</td>
<td style="text-align:left;">
2023-01-20 11:11:00
</td>
<td style="text-align:left;">
2023-01-20
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-20 11:13:10
</td>
<td style="text-align:right;">
1.28
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.78
</td>
<td style="text-align:right;">
-1.28
</td>
<td style="text-align:right;">
-1.78
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
24.999994
</td>
<td style="text-align:left;">
2023-01-20 11:13:10
</td>
<td style="text-align:left;">
2023-01-20 11:13:00
</td>
<td style="text-align:left;">
2023-01-20
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2023-01-20 11:21:21
</td>
<td style="text-align:right;">
2.43
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
8.15
</td>
<td style="text-align:right;">
-2.43
</td>
<td style="text-align:right;">
-8.15
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
24.999994
</td>
<td style="text-align:left;">
2023-01-20 11:21:21
</td>
<td style="text-align:left;">
2023-01-20 11:21:00
</td>
<td style="text-align:left;">
2023-01-20
</td>
</tr>
</tbody>
</table>
<p>One thing I noticed here is that the maximum depth is often not recorded in one of the two-second samples. For example, in first dive (which was probably just a practice <a href="https://www.youtube.com/watch?v=5oyfvvz51Fc">duck dive</a>), the max depth is 2.01 metres but none of the four samples include this depth measurement. I can only guess that the sampling rate is more frequent, but that the watch only saves the two-second intervals and the max depth.</p>
<p>Anyway, as we can already see, not all of these 102 dives were ‘proper’ dives. I know for sure that two of them are Scuba dives, and many of them will be dives for which I was a <a href="https://www.deeperblue.com/safety-for-freediving/">safety buddy</a>. The Scuba dives are easily identifiable by the ‘mode’. To filter out safety dives, I have simply subsetted the data for dives which were shallower than eight metres. This is completely arbitrary: some of my safety dives will have been deeper, and some of my ‘proper dive’ attempts will have been shallower, but you can choose whatever threshold you’d like.</p>
<pre class="r"><code># Remove SCUBA dives, and likely safety-buddy dives.
dive_info_clean_df &lt;- dive_info_df %&gt;%
  filter(mode == 3, max_depth &gt; 8) %&gt;% 
  mutate(dive_id = as.numeric(dive_id))</code></pre>
</div>
<div id="dive-profile" class="section level2">
<h2>Dive profile</h2>
<p>With the data in tidy format, things get easier and more fun. The main graphic I wanted to create is a ‘dive profile’ visual for which we plot the depth on the Y-axis and the duration on the X-axis using <code>ggplot2</code>. In this plot, I colour the line according to the depth, which is measures at the two-second sampling rate.</p>
<pre class="r"><code># Plot dives profile.
dive_info_clean_df %&gt;% 
  ggplot(data = .) +
  geom_line(mapping = aes(x = time, y = depth_minus, group = dive_id, colour = depth_minus),
            size = 1, alpha = 1) +
  scale_colour_viridis_c() +
  scale_x_continuous(breaks = c(0, 15, 30, 45, 60, 75, 90, 105)) +
  theme_bw() +
  geom_hline(yintercept = 0, linetype = &quot;dotted&quot;) +
  labs(y = &quot;Depth (metres)&quot;, x = &quot;Time (seconds)&quot;) +
  theme(legend.position = &quot;none&quot;) </code></pre>
<p><img src="https://raw.githubusercontent.com/langtonhugh/freedives/main/visuals/dive_profile.png" /><!-- --></p>
<p>Most of these dives will have been following a vertical rope for safety, as per the photo above. One downside of the dive profile graphic is that at first glance it might imply that the dives are covering distance along the X-axis. But, I think with the proper labeling it is a nice visual representation of the dives. We can easily differentiate outliers by both time (such as a hang at around 12 metres) and my two deepest dives (both are ~25 metres). Any other ideas, let me know. One thing I’d like to fix is the colouring by depth: at high resolution, we can see the segments for the sampling rate. I’d rather it was a smooth gradient colour. But, we go some way to remedy this later.</p>
</div>
<div id="chronology" class="section level2">
<h2>Chronology</h2>
<p>To explore progression over time (which for this data, is only 2023), I create a chronological id variable based on the dates. The order of the dives is interesting, but not so much the date itself. Maybe there’s a nicer way of doing this, but it certainly made the plot later easier. The idea is to later plot max depth progression in chronological order.</p>
<pre class="r"><code># Create chronological id and join back with the main data.
dive_info_clean_df &lt;- dive_info_clean_df %&gt;% 
  distinct(date_lub) %&gt;% 
  mutate(chrono_id = 1:nrow(.)) %&gt;% 
  right_join(dive_info_clean_df)</code></pre>
<p>We can then visualise, by each dive, the max depth using an (upside down) lollipop graphic.</p>
<pre class="r"><code># Basic chronology plot.
dive_info_clean_df %&gt;% 
  distinct(chrono_id, max_depth_minus, .keep_all = TRUE) %&gt;%
  ggplot(data = .) +
  geom_segment(mapping = aes(x = chrono_id, xend = chrono_id,
                             y = 0, yend = max_depth_minus)) +
  geom_point  (mapping = aes(x = chrono_id, y = max_depth_minus)) +
  geom_hline(yintercept = 0, linetype = &quot;dotted&quot;) +
  theme_bw() +
  labs(x = &quot;Dive number (chronological)&quot;, y = &quot;Depth (metres)&quot;) </code></pre>
<p><img src="https://raw.githubusercontent.com/langtonhugh/freedives/main/visuals/basic_chronology.png" /><!-- --></p>
<p>This might prove useful in its own right, but it lacks the colour which perfectly (for me) represents the depth. The deeper you go, the darker it gets. I came up with a rather messy way of adding incremental depth measurements between zero metres (i.e., the surface) and the max depth (the turn on the line). I do this using the <code>seq()</code> function, specifying a sequence of 0.5 metres. This is nested within <code>sapply()</code> so that we generate the sequence for each dive record. The output is a list, so I then convert the sequence to a character, remove the <code>c(</code> and <code>)</code> sandwiching the sequence, and pivot to long format by splitting rows by the comma. The final step is to make each value negative again.</p>
<pre class="r"><code># Add incremental steps to the max_depths.
dive_sequence_df &lt;- dive_info_clean_df %&gt;% 
  mutate(depth_sequence = sapply(dive_info_clean_df$max_depth, function(x)seq(0, x, by = 0.5))) %&gt;%
  select(chrono_id, depth_sequence) %&gt;% 
  mutate(depth_sequence = as.character(depth_sequence),
         depth_sequence = str_sub(depth_sequence, 3, -2)) %&gt;% 
  separate_rows(depth_sequence, sep = &quot;,&quot;) %&gt;% 
  mutate(depth_sequence = -1*as.numeric(trimws(depth_sequence)))</code></pre>
<p>We can reproduce the chronology plot but colour the line according to the sequence, with a minor addition to the basic <code>ggplot2</code> code chunk. You’ll notice that I create a mini data frame beforehand which contains only the chrono id and the max depth measure. This lets me add (coloured) points to the end of each line, but perhaps there’s some smarter <code>ggplot2</code> code that would avoid the pre-step.</p>
<pre class="r"><code># Identify the max depth for each chrono id.
max_depth_chrono_df &lt;- dive_sequence_df %&gt;% 
  group_by(chrono_id) %&gt;% 
  summarise(max_depth_minus = min(depth_sequence))

# Plot the sequence graph again.
ggplot() +
  geom_line(data = dive_sequence_df, mapping = aes(x = chrono_id, y = depth_sequence, group = chrono_id,
                          colour = depth_sequence), size = 2) +
  geom_point(data = max_depth_chrono_df,
             mapping = aes(x = chrono_id, y = max_depth_minus, 
                           colour = max_depth_minus), size = 3) +
  geom_hline(yintercept = 0, linetype = &quot;dotted&quot;) +
  scale_colour_viridis_c() +
  theme_bw() +
  labs(x = &quot;Dive number (chronological)&quot;, y = &quot;Depth (metres)&quot;) +
  theme(legend.position = &quot;none&quot;)  </code></pre>
<p><img src="https://raw.githubusercontent.com/langtonhugh/freedives/main/visuals/improved_chronology.png" /><!-- --></p>
<p>Finally, we can summarise the distribution of max depth, along with the temperature of the water and duration of each dive. This step is pretty straightforward. The <code>pivot_longer()</code> means that we can <code>facet_wrap()</code> rather than create each plot individually.</p>
<pre class="r"><code># Distribution handling and plot.
dive_info_clean_df %&gt;% 
  select(dive_id, duration, max_depth, temp) %&gt;% 
  distinct() %&gt;% 
  rename(`Duration (seconds)` = duration,
         `Max. depth (metres)`  = max_depth,
         `Temperature (C)` = temp) %&gt;% 
  pivot_longer(cols = -dive_id, names_to = &quot;stat&quot;) %&gt;% 
  ggplot(data = .) +
  geom_density(mapping = aes(x = value), fill = &quot;grey20&quot;, colour = &quot;grey20&quot;) +
  facet_wrap(~stat, scales = &quot;free&quot;) +
  theme_bw() +
  labs(x = NULL, y = NULL)</code></pre>
<p><img src="https://raw.githubusercontent.com/langtonhugh/freedives/main/visuals/enviro_density.png" /><!-- --></p>
<p>Well, that’s pretty much it for now! It’s a start. The code should work pretty seamlessly for anyone with a Suunto D4F, but the drag-and-drop dashboard might be a long way off yet. This is partly because I don’t know to what extent this code will run on dive logs from different brands and model of watch. If you get it running using your own data (irrespective of the watch model) let me know!</p>
</div>
