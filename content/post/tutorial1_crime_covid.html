---
title: "Tutorial: visualising lockdown crime trends"
subtitle: "<font size=2> This post will be updated periodically upon new data releases. Please do [get in contact](https://www.samlangton.info/#contact) if you encounter any issues! <font size=4.9>"
tags:
- policing
- crime
- COVID
- R
- ggplot2
editor_options: 
  chunk_output_type: console
date: '2020-07-01'
---



<p>Over the past few weeks I have spent a bit of time exploring police recorded crime trends before and after nationwide lockdowns induced by the COVID19 pandemic. Some of this has involved making <a href="https://theconversation.com/lockdown-crime-trends-why-antisocial-behaviour-is-up-140479">descriptive graphics</a> across different crime types, using London (UK) as a case study.</p>
<p>In this post, I will take you through how you can create these visuals in <code>R</code>. It’s worth emphasising that this is simply a demonstration of ‘how I get did’ not ‘how to do it’ – there will be many ways of doing the same thing, some probably more beautiful and concise.</p>
<div id="background" class="section level2">
<h2>Background</h2>
<p>There has been talk of lockdowns representing the <a href="https://link.springer.com/article/10.1007/s12103-020-09546-0">largest natural experiment in criminological history</a>. Of course, this kind of claim will be challenged, especially when demonstrations involve police recorded crime data. Lots of parameters will have changed beyond people’s routine activities, amongst them, people’s ability and willingness to report crimes to the police, and policing resource allocation. It might be some time before we can fully understand how lockdowns have curbed the spatial and temporal patterns of crime.</p>
<p>In the meantime, police recorded crime data can offer a unique insight into how criminal behaviour <em>might</em> have changed in the past few months. In the UK, open data is released on a monthly basis. This <a href="https://the-sra.org.uk/SRA/Blog/whyyoucantidentifychangesincrimebycomparingthismonthtolastmonth.aspx">isn’t ideal</a> by any means, but it does allow for some preliminary exploration. Here, we’re going to create a descriptive visualisation inspired by some infamous graphs by <a href="https://www.ft.com/content/a26fbf7e-48f8-11ea-aeb3-955839e06441">the FT</a> used to track COVID19 deaths.</p>
<p><img src="/img/ft_example.png" /></p>
<p>One powerful thing about these visuals is that they effortlessly account for <em>seasonal</em> trends in death rates using previous years as a reference point. Readers can then intuitively understand what is ‘normal’, and identify fluctuations which are irregular, and thus likely a result of COVID19.</p>
<p>Similarly, a key characteristic of long-term crime trends is seasonality. To disentangle fluctuations in crime, and pinpoint irregularity resulting from lockdown measures, we must account for typical monthly fluctuations. We can do this descriptively (and visually) using open police recorded crime data and some packages in <code>R</code>.</p>
<p>For now, we will focus on the base visual – perhaps in further posts I can demonstrate how to more accurately mimic the ‘FT look’. We’ll aim for something like the graphic below, representing multiple crime type trends in London from January 2016 to May 2020.</p>
<p><img src="/img/full_met.png" /></p>
</div>
<div id="project-and-packages" class="section level2">
<h2>Project and packages</h2>
<p>To make following this tutorial easier, some of you might want to download the associated repository on GitHub. By working within the R project on the repository, and using the same folder structure, the subsequent code won’t need to be edited. Any data we download should just be placed into the <strong>data</strong> folder, and named accordingly. Whatever works for you!</p>
<p>Although we are mainly using <code>ggplot2</code> for the visual, we use a number of other packages for data wrangling and plot arrangement. Load them using <code>library()</code> now. If you don’t have some of these packages, ensure they are installed using <code>install.packages()</code>.</p>
<pre class="r"><code>library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(stringr)</code></pre>
</div>
<div id="open-crime-data" class="section level2">
<h2>Open crime data</h2>
<p>First, we need the data. There are several ways to download <a href="https://data.police.uk/">open police data</a> in the UK. There is an <a href="https://data.police.uk/docs/">API</a>, an <a href="https://github.com/njtierney/ukpolice">R package</a>, and a <a href="https://data.police.uk/data/">direct download page</a> from the website.</p>
<p>Here, we are going to get most of the data through direct download from the <a href="https://data.police.uk/data/">online data portal</a>. Remembering that we want previous years as our reference point, we are going to select the widest date range possible (at the time of writing), which is the 36 months spanning from June 2017 to May 2020. As new data is released, this 36-month window will shift. So for example, once June 2020 becomes available, you will only be able to download July 2017 to June 2020. This isn’t a huge deal, but remember to take that into account when following subsequent steps.</p>
<p>You can select the latest 36-month range using the dropdown menus, and then tick whatever police force(s) we want. In this example, I am going to use the Metropolitan Police Service, which serve Greater London. So, our selection will look something like this:</p>
<p><img src="/img/dates_met.png" /></p>
<p>We can then ‘Generate file’ at the bottom of the page, and on the next page, download a .zip file containing all our crime data for the past 36 months. Here, I call the .zip file <strong>met_police_june2017_to_june2020</strong> and save it to a local folder named <strong>data</strong>, as per the associated GitHub repository.</p>
<p>Ideally, I’d like to go even further back, before June 2017, to get the best picture possible about seasonal crime trends. We can do this using the open <a href="https://data.police.uk/data/archive/">archive</a> data. This comes in a pretty unfriendly format, because you cannot download by force, and cannot select specific time periods. Anyway, you can download all the data prior to June 2017 using a direct download from the <a href="https://data.police.uk/data/archive/">archive page</a> and the following option:</p>
<p><img src="/img/archive.png" /></p>
<p>Remember that if your 36-month window is more recent than this demonstration, you will need to select a different corresponding archive folder! I name mine <strong>archive_to_jun_2017</strong> and save it in the same <strong>data</strong> folder. Note that this might take 5-10 minutes to download, depending on your internet connection. Once unzipped, you should have two folders in your <strong>data</strong> folder, named accordingly. Mine look like this:</p>
<p><img src="/img/file_names.png" /></p>
</div>
<div id="loading-the-data" class="section level2">
<h2>Loading the data</h2>
<p>You will notice that, once unzipped, data for the last 36 months (named <strong>met_police_june2017_to_june2020</strong>) is spread across multiple folders – one for each month. This is not ideal, but using some tricks in <code>R</code> we can automatically load these files and bind them together into one data frame.</p>
<p>First, let’s generate a list containing all the working directories and .csv files in the downloaded folder. Note that we are taking the location and name of the folder relative to where our R project is saved (<code>"data/met_police_june2017_to_june2020/"</code>), extracting the name of every .csv file contained within it, and pasting them together.</p>
<pre class="r"><code># Extract list of working directories + file names for each csv.
file_names &lt;- paste(&quot;data/met_police_june2017_to_june2020/&quot;, list.files(&quot;data/met_police_june2017_to_june2020&quot;, &quot;*.csv&quot;, recursive=TRUE), sep = &quot;&quot;)</code></pre>
<p>Printing the object <code>file_names</code> to your Console will provide you with the working directory and file name of the .csv files – of which there are 36 – contained within <strong>met_police_june2017_to_june2020</strong>. We can then load all of these .csv files into <code>R</code> by looping the <code>read_csv()</code> function from <code>readr</code> through the <code>file_names</code> object.</p>
<pre class="r"><code># Loop through each to load.
met_list &lt;- lapply(file_names, read_csv)</code></pre>
<p>Okay, we are nearly there. We can complete the missing months for 2017 using the archive material. Again, remember that you might need additional months depending on the 36-month time window you’re using. Here, we only need January to May, so rather than use another loop, let’s just load them individually, assigning them to meaningful object names.</p>
<pre class="r"><code>jan17_df &lt;- read_csv(&quot;data/archive_to_jun_2017/2017-01/2017-01-metropolitan-street.csv&quot;)
feb17_df &lt;- read_csv(&quot;data/archive_to_jun_2017/2017-02/2017-02-metropolitan-street.csv&quot;) 
mar17_df &lt;- read_csv(&quot;data/archive_to_jun_2017/2017-03/2017-03-metropolitan-street.csv&quot;) 
apr17_df &lt;- read_csv(&quot;data/archive_to_jun_2017/2017-04/2017-04-metropolitan-street.csv&quot;) 
may17_df &lt;- read_csv(&quot;data/archive_to_jun_2017/2017-05/2017-05-metropolitan-street.csv&quot;) </code></pre>
<p>Finally (the interesting bit is coming, I promise), let’s extract the monthly data for 2016 from the archive data, so we have the complete set from 2016-2020. We do this like the first example, but with a few extra options to ensure that we select data from the Metropolitan Police only, rather than every police force. Remember that the archive data automatically contains data from every police force – but we only want the Met.</p>
<pre class="r"><code># Extract 2016 for the Met only.
dates_2016 &lt;- list.files(&quot;data/archive_to_jun_2017&quot;, pattern = &quot;2016&quot;)
extra &lt;- paste(&quot;data/archive_to_jun_2017&quot;, &quot;/&quot;, dates_2016, &quot;/&quot;, dates_2016, &quot;-&quot;, &quot;metropolitan-street.csv&quot;, sep = &quot;&quot;)

# Load in loop.
met_2016_list &lt;- lapply(extra, read_csv)</code></pre>
<p>Now, at last, we can bind all these data together row-wise using <code>bind_rows()</code>. The resulting object <code>met_full_df</code> contains all records for the Metropolitan Police from Janury 2016 to May 2020. Okay, it’s been a bit of palavar, but we have managed to download and compile over 4.5 million crime records with (relative) ease. Hurrah!</p>
<pre class="r"><code># Bind these to existing data frame objects.
met_full_df &lt;- bind_rows(met_2016_list, jan17_df, feb17_df, mar17_df, apr17_df, may17_df, met_recent_df)</code></pre>
</div>
<div id="visual-plot" class="section level2">
<h2>Visual plot</h2>
<p>What we have currently are individual records of crime recorded by the Met from January 2016 to May 2020. We can aggregate these records by month, year and crime type using a series of functions in <code>dplyr</code> along with the piping operator <code>%&gt;%</code>. Note the steps taken. We first filter out ‘other crimes’ – a crude decision simply because I don’t think this crime type offers much insight. We then create separate month and year variables, group by months, years and crime type, count the number of crimes for each combination, arrange for easy viewing, and then ungroup. The final step splits the data frame into a list of data frames by each crime type, so we can easily generate a plot for each crime type later.</p>
<pre class="r"><code># Counts.
met_stats_df &lt;- met_full_df %&gt;%                             # select the data frame
  filter(`Crime type` != &quot;Other crime&quot;)                     # filter out other crimes
  separate(Month, into = c(&quot;Year&quot;,&quot;Month&quot;), sep = &quot;-&quot;) %&gt;%  # create new &#39;month&#39; and &#39;year&#39; variables
  group_by(Year, Month, `Crime type`) %&gt;%                   # group by year, month and crime type
  summarise(counts = n()) %&gt;%                               # count rows per group combination
  arrange(`Crime type`, Year, Month) %&gt;%                    # sort data frame for viewing with View()
  ungroup() %&gt;%                                             # ungroup data frame
  split_group(`Crime type`)                                 # split into lists of df by crime type</code></pre>
<p>We can then create the <code>ggplot</code> function which will be used to generate the plots for each crime type.</p>
<pre class="r"><code># Base visual function.
plot_fun &lt;- function(x){
  ggplot() +
    geom_line(data = filter(x, Year != 2020),
              mapping = aes(x = Month, y = counts, group = Year),
              colour = &quot;lightgrey&quot;) +
    geom_vline(data = x,
               mapping = aes(xintercept = 2.7),
               linetype = &quot;dotted&quot;) + 
    stat_summary(data = filter(x, Year != 2020),
                 aes(x = Month, y = counts, group = Year),
                 fun = mean, colour = &quot;white&quot;, geom = &quot;line&quot;, group=1, size = 0.8) +
    stat_summary(data = filter(x, Year != 2020),
                 aes(x = Month, y = counts, group = Year),
                 fun = mean, colour = &quot;black&quot;, geom = &quot;line&quot;, group=1, size = 0.7) +
    geom_line(data = filter(x, Year == 2020),
              mapping = aes(x = Month, y = counts, group = 1),
              colour = &quot;white&quot;, size = 1.1) +
    geom_line(data = filter(x, Year == 2020),
              mapping = aes(x = Month, y = counts, group = 1),
              colour = &quot;tomato&quot;, size = 1) +
    scale_x_discrete(labels = c(&quot; &quot;,&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,&quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;)) +
    scale_y_continuous(limits = c(0.6*min(x$counts), 1.4*max(x$counts))) +
    labs(x = NULL, y = NULL) +
    theme_bw() +
    theme(axis.title = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 6),
          axis.ticks = element_blank(),
          plot.title = element_text(size = 8))  
}</code></pre>
<p>This function can then be looped through <code>met_stats_list</code>, the list of data frames by crime type. Note that we first name each data frame in the list so that we can add titles automatically. In doing so, we also remove the underscores. The resulting object <code>met_stats_plots</code> is a list of ggplot objects, visualising crime trends for each crime type.</p>
<pre class="r"><code># Create a character vector naming each crime type, which helps us automatically add titles to our plots.
names(met_stats_list) &lt;- sort(unique(met_full_df$`Crime type`))

# Make plots and add titles.
met_stats_plots &lt;- list()
for (i in seq(met_stats_list)) {
  gg &lt;- plot_fun(met_stats_list[[i]]) +
    labs(title = str_replace_all(string = names(met_stats_list[i]), &quot;_&quot;, &quot; &quot;))
  met_stats_plots[[i]] &lt;- gg
}</code></pre>
<p>We can arrange the list of plots using the <code>plot_grid()</code> function from <code>cowplot</code> to get a basic summary of crime trends in London.</p>
<pre class="r"><code># Plot grid.
plot_grid(plotlist = met_stats_plots, ncol = 3)</code></pre>
<p><img src="/img/full_met_basic.png" /></p>
</div>
<div id="annotating-and-arranging" class="section level2">
<h2>Annotating and arranging</h2>
<p>The problem with the above graph is the lack of annotation. Rather than add a legend, we can simply annotate one of these plots. The starkest trend is probably anti-social behaviour, so let’s retrieve this plot from our list.</p>
<pre class="r"><code># Pluck out ASB for annotation.
Anti_social_behaviour &lt;- pluck(met_stats_plots, 1)</code></pre>
<p>We can then add arrows and text labels using <code>annotate()</code>. This seems rather fiddly at first (because it is) but once you’re used to it, stating accurate x and y arguments is quite straightforward. Note that by specifying <code>axis.text.x</code> we bring back the x-axis annotation we used in the original function, specifying the months.</p>
<pre class="r"><code># Annotate.
asb &lt;- Anti_social_behaviour +
  theme(axis.text.x = element_text(size = 6, angle = 90, vjust = -1.5)) +
  labs(title = &quot;Anti-social behaviour&quot;) +
  #2020 label
  annotate(geom = &quot;curve&quot; , x = 7, y = 73000, xend = 5, yend = 61000,
           curvature = 0.3, arrow = arrow(length = unit(1, &quot;mm&quot;))) +
  annotate(geom = &quot;text&quot;, x = 7.8, y = 73000, label = &quot;2020&quot;, fontface = &quot;bold&quot;, size = 3) +
  #lockdown label
  annotate(geom = &quot;curve&quot;, x = 4, y = 9000, xend = 2.8, yend = 9000,
           curvature = 0.1, arrow = arrow(length = unit(1, &quot;mm&quot;))) +
  annotate(geom = &quot;text&quot;, x = 5.5, y = 9000, label = &quot;Lockdown&quot;, fontface = &quot;bold&quot;, size = 3) +
  #recent years label
  annotate(geom = &quot;curve&quot;, x = 8, y = 38500, xend = 8.3, yend = 26000,
           curvature = -0.1, arrow = arrow(length = unit(1, &quot;mm&quot;))) +
  annotate(geom = &quot;text&quot;, x = 8, y = 43000, label = &quot;Recent years (inc. mean)&quot;, fontface = &quot;bold&quot;, size = 3) </code></pre>
<p>Now we’ve made a separate (annotated) plot for anti-social behaviour, we can get rid of the one contained in our original list.</p>
<pre class="r"><code># Remove ASB for plot list to avoid repeat.
met_stats_plots[[1]] &lt;- NULL</code></pre>
<p>Then comes the arranging. Here, I use the <code>plot_grid</code> function from the amusingly named <code>cowplot</code> package. Again, this is quite fiddly – an alternative might be <a href="https://github.com/thomasp85/patchwork">patchwork</a>, but I am quite familiar with cowplot already. Note that we actually create two separate cowplots – one for anti-social behaviour, and one for our main plots – and then stick them together.</p>
<pre class="r"><code>asb_blank &lt;- plot_grid(asb, NULL, nrow = 1)
all_plots &lt;- plot_grid(plotlist = met_stats_plots, nrow = 4)
full_plot &lt;- plot_grid(asb_blank, all_plots, nrow = 2, rel_heights = c(2,5))</code></pre>
<p>You can then print the plot to your <strong>Viewer</strong> or save it.</p>
<pre class="r"><code># Save
ggsave(full_plot, filename = &quot;visuals/full_met.png&quot;, height = 8, width = 6)</code></pre>
<p><img src="/img/full_met.png" /></p>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
</div>
